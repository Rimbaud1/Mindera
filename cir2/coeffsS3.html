<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>CIR1 S3 – Visualisation & Calcul</title>
  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles */
    .gradient-bg {
      background: linear-gradient(135deg, #a78bfa 0%, #6d28d9 100%); /* New gradient for S3 */
    }
    .chart-container {
      transition: all 0.3s ease;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .chart-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .input-radio-container:hover .radio-label {
      color: #7c3aed; /* Changed hover color */
    }
    .radio-custom {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      transition: all 0.2s ease;
      position: relative;
      cursor: pointer;
    }
    .radio-custom:checked {
      border-color: #7c3aed; /* Changed checked color */
      background-color: #7c3aed;
    }
    .radio-custom:checked::after {
      content: "";
      position: absolute;
      top: 2px;
      left: 2px;
      width: 10px;
      height: 10px;
      background-color: white;
      border-radius: 50%;
    }
    .note-input {
      transition: all 0.2s ease;
      border: 1px solid #d1d5db;
    }
    .note-input:focus {
      border-color: #7c3aed; /* Changed focus color */
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }
    .btn-primary {
      transition: all 0.2s ease;
      background: linear-gradient(135deg, #a78bfa 0%, #6d28d9 100%); /* New gradient */
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .btn-secondary {
      transition: all 0.2s ease;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    }
    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .result-box {
      background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); /* New light result box */
      border-left: 4px solid #8b5cf6; /* Changed border color */
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="gradient-bg text-white py-6 shadow-lg">
    <div class="container mx-auto px-4">
      <h1 class="text-3xl font-bold text-center">
        <i class="fas fa-chart-pie mr-2"></i> Pondérations CIR1 S3
      </h1>
      <p class="text-center text-purple-100 mt-2">
        Visualisation interactive & calculateur de moyenne
      </p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <div class="flex-1">
        <div class="bg-white rounded-xl p-6 chart-container">
          <div id="chart_div" class="w-full h-[500px]"></div>
        </div>
        <div class="text-center mt-4">
          <button id="backBtn" class="btn-secondary py-2 px-6 rounded-lg font-medium text-gray-700 hidden" onclick="goBack()">
            <i class="fas fa-arrow-left mr-2"></i> Retour
          </button>
        </div>
      </div>

      <div class="w-full lg:w-96">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="gradient-bg px-6 py-4">
            <h2 class="text-xl font-bold text-white flex items-center">
              <i class="fas fa-calculator mr-3"></i> Calculateur de moyenne
            </h2>
          </div>
          <div class="p-6">
            <p class="text-gray-600 mb-6 text-sm">
              Saisissez les notes déjà connues. Cochez la case pour la note inconnue. 
              Cliquez sur « Calculer » pour savoir combien il faut pour avoir 10 de moyenne.
            </p>
            
            <div id="notesForm" class="space-y-4 mb-6"></div>
            
            <button onclick="calculerMoyenne()" class="btn-primary w-full py-3 rounded-lg text-white font-medium">
              <i class="fas fa-calculator mr-2"></i> Calculer
            </button>
            
            <div id="calcResult" class="result-box p-4 mt-6 rounded-lg hidden">
              <div class="flex items-start">
                <i class="fas fa-info-circle text-purple-600 mt-1 mr-3"></i> <div id="resultContent"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-gray-100 py-6 mt-12">
    <div class="container mx-auto px-4 text-center text-gray-600">
      <p>© 2025 CIR1 S3 - Outil de visualisation des pondérations</p>
    </div>
  </footer>

<script>
  // --------------------------------------------------------------------
  // 1) Données en 2 niveaux (UE → Modules) pour le Semestre 3 (S3)
  //    (Le niveau 3 est supprimé car non détaillé dans l'image)
  // --------------------------------------------------------------------
  google.charts.load('current', { packages: ['corechart'] });
  google.charts.setOnLoadCallback(drawLevel1);

  // -- NIVEAU 1 : 5 UE (nom + ECTS) - Basé sur l'image S3
  const dataNiveau1 = [
    ['Mathématiques (UE1.3.1)', 8],
    ['Physique, Électronique (UE1.3.2)', 5],
    ['Informatique (UE1.3.3)', 8],
    ['Humanités, Langues (UE1.3.4)', 7],
    ['Stage (UE1.3.5)', 2],
  ];

  // -- NIVEAU 2 : sous-modules pour chaque UE, avec poids en % - Basé sur l'image S3
  const dataNiveau2 = [
    {
      name: 'Mathématiques (UE1.3.1)',
      modules: [
        ['M5 : Calcul différentiel', 40],
        ['M6 : Analyse avancée', 40],
        ['Maths TP', 20]
      ]
    },
    {
      name: 'Physique, Électronique (UE1.3.2)',
      modules: [
        ['Électromagnétisme', 70],
        ['Automatique séquentielle', 30]
      ]
    },
    {
      name: 'Informatique (UE1.3.3)',
      modules: [
        ['Prog 3 : Orientée Objet', 70],
        ['Informatique embarquée', 30]
      ]
    },
    {
      name: 'Humanités, Langues (UE1.3.4)',
      modules: [
        ['Anglais', 35],
        ['Science et société', 30],
        ['Expression écrite', 10],
        ['Expression orale', 10],
        ['Épistémologie', 15]
      ]
    },
    {
      name: 'Stage (UE1.3.5)',
      modules: [
        ['Stage d\'exécution', 100]
      ]
    }
  ];

  // Le niveau 3 (dataNiveau3) est supprimé car les épreuves ne sont pas détaillées
  // dans l'image de S3 fournie.

  // Variables d'état
  let currentLevel = 1;
  let currentUEName = "";
  // let currentSubModuleName = ""; // Plus nécessaire

  // --------------------------------------------------------------------
  // Fonctions de dessin des camemberts
  // --------------------------------------------------------------------
  function drawLevel1() {
    currentLevel = 1;
    document.getElementById('backBtn').classList.add('hidden');
    renderCalcForm();

    const data = new google.visualization.DataTable();
    data.addColumn('string', 'UE');
    data.addColumn('number', 'ECTS');
    data.addRows(dataNiveau1);

    const options = {
      title: "Répartition des UE du S3 (en ECTS)",
      backgroundColor: 'transparent',
      chartArea: {
        left: 50,
        top: 50,
        width: "80%",
        height: "70%"
      },
      legend: { position: 'right' },
      // Couleurs mises à jour pour mieux correspondre au nouveau gradient
      colors: ['#a78bfa', '#8b5cf6', '#6d28d9', '#5b21b6', '#3b0764'],
      titleTextStyle: {
        fontSize: 18,
        bold: true,
        color: '#374151'
      }
    };

    const chart = new google.visualization.PieChart(document.getElementById('chart_div'));
    google.visualization.events.addListener(chart, 'select', function() {
      const sel = chart.getSelection()[0];
      if (sel) {
        const ueName = data.getValue(sel.row, 0);
        currentUEName = ueName;
        drawLevel2(ueName);
      }
    });
    chart.draw(data, options);
  }

  function drawLevel2(ueName) {
    currentLevel = 2;
    document.getElementById('backBtn').classList.remove('hidden');
    renderCalcForm();

    const ueObj = dataNiveau2.find(o => o.name === ueName);
    if (!ueObj) return;

    const data = new google.visualization.DataTable();
    data.addColumn('string', 'Module');
    data.addColumn('number', 'Poids %');
    data.addRows(ueObj.modules);

    const options = {
      title: ueName,
      backgroundColor: 'transparent',
      chartArea: {
        left: 50,
        top: 50,
        width: "80%",
        height: "70%"
      },
      legend: { position: 'right' },
      // Couleurs mises à jour
      colors: ['#a78bfa', '#8b5cf6', '#6d28d9', '#5b21b6', '#3b0764'],
      titleTextStyle: {
        fontSize: 18,
        bold: true,
        color: '#374151'
      }
    };

    const chart = new google.visualization.PieChart(document.getElementById('chart_div'));
    // Événement de sélection désactivé, car le niveau 3 n'est pas supporté
    // google.visualization.events.addListener(chart, 'select', function() {
    //   const sel = chart.getSelection()[0];
    //   if (sel) {
    //     const subModuleName = data.getValue(sel.row, 0);
    //     currentSubModuleName = subModuleName;
    //     drawLevel3(subModuleName); // Ceci renverrait une erreur si on n'a pas les données
    //   }
    // });
    chart.draw(data, options);
  }

  // Suppression de drawLevel3

  // Bouton "Retour"
  function goBack() {
    // On ne gère plus que le retour du Niveau 2 au Niveau 1
    if (currentLevel === 2) {
      drawLevel1();
    }
  }

  // --------------------------------------------------------------------
  // Génération du FORMULAIRE de notes
  // --------------------------------------------------------------------
  function renderCalcForm() {
    const formZone = document.getElementById('notesForm');
    formZone.innerHTML = '';
    document.getElementById('calcResult').classList.add('hidden');

    if (currentLevel === 1) {
      // Niveau 1: UEs
      dataNiveau1.forEach((row, idx) => {
        const ueName = row[0];
        const ueECTS = row[1];
        
        const div = createInputRow(ueName, `ECTS: ${ueECTS}`, idx, 'lvl1');
        formZone.appendChild(div);
      });

    } else if (currentLevel === 2) {
      // Niveau 2: Modules
      const ueObj = dataNiveau2.find(o => o.name === currentUEName);
      if (!ueObj) return;

      ueObj.modules.forEach((m, idx) => {
        const moduleName = m[0];
        const modulePct = m[1];
        
        const div = createInputRow(moduleName, `${modulePct}%`, idx, 'lvl2');
        formZone.appendChild(div);
      });

    }
    // Le Niveau 3 est retiré
  }

  // Fonction utilitaire pour créer une ligne d'entrée de note
  function createInputRow(labelName, weightLabel, index, levelPrefix) {
    const div = document.createElement('div');
    div.className = 'input-radio-container flex items-center justify-between p-3 bg-gray-50 rounded-lg';
    
    const label = document.createElement('label');
    label.className = 'radio-label text-sm font-medium text-gray-700 flex-1';
    label.textContent = `${labelName} (${weightLabel})`;
    
    const inputContainer = document.createElement('div');
    inputContainer.className = 'flex items-center space-x-3';
    
    const input = document.createElement('input');
    input.type = 'number';
    input.step = '0.1';
    input.min = '0';
    input.max = '20';
    input.id = `${levelPrefix}_input_${index}`;
    input.className = 'note-input w-20 px-3 py-2 rounded-md text-sm';
    input.placeholder = '/20';
    
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'unknownNote';
    radio.value = index;
    radio.className = 'radio-custom';
    radio.id = `${levelPrefix}_radio_${index}`;
    
    const radioLabel = document.createElement('label');
    radioLabel.htmlFor = `${levelPrefix}_radio_${index}`;
    radioLabel.className = 'text-xs text-gray-500 ml-1';
    radioLabel.innerHTML = '<i class="fas fa-question-circle"></i>';
    radioLabel.title = "Note inconnue";
    
    inputContainer.appendChild(input);
    inputContainer.appendChild(radio);
    inputContainer.appendChild(radioLabel);
    
    div.appendChild(label);
    div.appendChild(inputContainer);
    return div;
  }

  // --------------------------------------------------------------------
  // Calcul de la note inconnue pour obtenir 10/20 de moyenne
  // --------------------------------------------------------------------
  function calculerMoyenne() {
    const resultDiv = document.getElementById('calcResult');
    const resultContent = document.getElementById('resultContent');
    resultDiv.classList.remove('hidden');
    resultContent.innerHTML = '';

    if (currentLevel === 1) {
      const totalECTS = dataNiveau1.reduce((acc, row) => acc + row[1], 0);
      const unknownIndex = getUnknownIndex(dataNiveau1.length);
      let sumKnown = 0;
      
      dataNiveau1.forEach((row, idx) => {
        const ects = row[1];
        const val = parseFloat(document.getElementById(`lvl1_input_${idx}`).value);
        if (idx !== unknownIndex && !isNaN(val)) {
          sumKnown += (ects / totalECTS) * val;
        }
      });
      
      if (unknownIndex === -1) {
        showFinalAverage(sumKnown, "globale calculée", resultContent);
        return;
      }
      
      const ectsUnknown = dataNiveau1[unknownIndex][1];
      // Formula: needed = (10 - sum_known) / (weight_unknown)
      const needed = (10 - sumKnown) / (ectsUnknown / totalECTS);
      showCalcResult(needed, dataNiveau1[unknownIndex][0], resultContent, "en moyenne d'UE");

    } else if (currentLevel === 2) {
      const ueObj = dataNiveau2.find(o => o.name === currentUEName);
      if (!ueObj) return;
      
      const modules = ueObj.modules;
      const unknownIndex = getUnknownIndex(modules.length);
      let sumKnown = 0;

      modules.forEach((m, idx) => {
        const modPct = m[1];
        const val = parseFloat(document.getElementById(`lvl2_input_${idx}`).value);
        if (idx !== unknownIndex && !isNaN(val)) {
          sumKnown += (modPct / 100) * val;
        }
      });
      
      if (unknownIndex === -1) {
        showFinalAverage(sumKnown, `du bloc "${currentUEName}"`, resultContent);
        return;
      }
      
      const unknownPct = modules[unknownIndex][1];
      // Formula: needed = (10 - sum_known) / (weight_unknown)
      const needed = (10 - sumKnown) / (unknownPct / 100);
      showCalcResult(needed, modules[unknownIndex][0], resultContent, "en note de module");

    }
    // Le Niveau 3 est retiré
  }

  function getUnknownIndex(count) {
    const radios = document.getElementsByName('unknownNote');
    let idx = -1;
    for (let r of radios) {
      if (r.checked) {
        idx = parseInt(r.value);
        break;
      }
    }
    if (idx >= count) idx = -1;
    return idx;
  }

  function showFinalAverage(average, label, resultDiv) {
    resultDiv.innerHTML = `
      <p class="font-medium text-gray-800">Moyenne ${label}</p>
      <p class="text-lg text-purple-600 font-bold mt-1">${average.toFixed(2)}/20</p>
      <p class="text-sm text-gray-600 mt-1">Aucune note inconnue sélectionnée</p>
    `;
  }

  function showCalcResult(needed, label, resultDiv, type) {
    if (isNaN(needed)) {
      resultDiv.innerHTML = `
        <p class="font-medium text-red-600">Erreur de calcul</p>
        <p class="text-sm text-gray-600 mt-1">Veuillez vérifier les valeurs saisies</p>
      `;
      return;
    }
    
    if (needed < 0) {
      resultDiv.innerHTML = `
        <p class="font-medium text-green-600">Vous avez déjà la moyenne ! 🎉</p>
        <p class="text-sm text-gray-600 mt-1">Avec vos notes actuelles, vous avez déjà ≥10/20</p>
        <p class="text-xs text-gray-500 mt-2">(Le calcul donne ${needed.toFixed(2)}/20 ${type} "${label}")</p>
      `;
    } else if (needed > 20) {
      resultDiv.innerHTML = `
        <p class="font-medium text-red-600">Objectif inatteignable 😭</p>
        <p class="text-sm text-gray-600 mt-1">Il faudrait ${needed.toFixed(2)}/20 ${type} "${label}"</p>
        <p class="text-xs text-gray-500 mt-2">(Ce qui est impossible car la note est limitée à 20)</p>
      `;
    } else {
      resultDiv.innerHTML = `
        <p class="font-medium text-purple-600">Note nécessaire pour avoir 10/20</p>
        <p class="text-lg font-bold text-gray-800 mt-1">${needed.toFixed(2)}/20</p>
        <p class="text-sm text-gray-600 mt-1">${type} "${label}"</p>
      `;
    }
  }
</script>
</body>
</html>
